<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3"
      main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence>
      <SetBlackboard value="-0.35,0.0,0.0"
                     output_key="pre_grab_box_offset"/>
      <SetBlackboard value="-0.3,0.0,0.0"
                     output_key="pre_grab_box_offset_after_sgl_step"/>
      <SetBlackboard value="0.3,0.4,0.22"
                     output_key="box_size"/>
      <SetBlackboard value="-0.35,0.0,0"
                     output_key="pre_grab_box_offset2"/>
      <SetBlackboard value="1"
                     output_key="cur_id"/>
      <SetBlackboard value="0,0.0,0.0"
                     output_key="force_threshold"/>
      <SetBlackboard value="0.12,0.0,-0.9"
                     output_key="put_box_offset"/>
      <SetBlackboard value="0"
                     output_key="put_tag_id"/>
      <SetBlackboard value="0"
                     output_key="hand_side"/>
      <Sequence>
        <TimingDecorator name="Total">
          <Sequence>
            <RetryUntilSuccessful num_attempts="3">
              <CheckStatusOK/>
            </RetryUntilSuccessful>
            <SequenceStar>
              <SequenceStar>
                <TimingDecorator name="Grasp">
                  <Sequence>
                    <RetryUntilSuccessful num_attempts="10">
                      <BoxTagOK tag_id="{cur_id}"
                                box_pos="{box_pose}"
                                box_quat="{box_quat}"
                                time_check="true"/>
                    </RetryUntilSuccessful>
                    <Parallel failure_threshold="1"
                              success_threshold="2">
                      <ArmMoveToReadyPose action_name="claw_ready_joints"
                                          move_speed="1.0"/>
                      <Sequence>
                        <ComputeTargetPose box_pos="{box_pose}"
                                           box_quat="{box_quat}"
                                           target_box_offset="{pre_grab_box_offset2}"
                                           target_pose="{target_pose}"/>
                        <CmdPoseWorldMoveToDestination target_pose="{target_pose}"/>
                      </Sequence>
                    </Parallel>
                    <HeadMove control_mode="1"/>
                    <GetPartPose part_pos="{part_pos}"
                                 part_quat="{part_quat}"/>
                    <SelectHandSide part_pos="{part_pos}"
                                    part_quat="{part_quat}"
                                    target_part_offset="0.0,0.0,0.0"
                                    hand_side="{hand_side}"/>
                    <Sequence>
                      <ControlClaw action_mode="open"
                                   hand_to_control="{hand_side}"
                                   duration="2"/>
                      <ClawPart hand_pos="{part_pos}"
                                hand_quat="{part_quat}"
                                hand_offset="0.0,0.0,0.0"
                                hand_side="{hand_side}"
                                part_type="0"/>
                      <ControlClaw action_mode="close"
                                   hand_to_control="{hand_side}"
                                   duration="2"/>
                      <ClawPart hand_pos="{part_pos}"
                                hand_quat="{part_quat}"
                                hand_offset="0.0,0.0,0.0"
                                hand_side="{hand_side}"
                                part_type="1"/>
                      <ArmMoveToReadyPose action_name="claw_ready_joints"
                                          move_speed="1.0"/>
                    </Sequence>
                  </Sequence>
                </TimingDecorator>
              </SequenceStar>
            </SequenceStar>
          </Sequence>
        </TimingDecorator>
      </Sequence>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="ArmMoveToReadyPose"
            editable="true">
      <input_port name="action_name"/>
      <input_port name="move_speed"/>
    </Action>
    <Condition ID="BoxTagOK"
               editable="true">
      <input_port name="tag_id"/>
      <output_port name="box_pos"/>
      <output_port name="box_quat"/>
      <input_port name="time_check"
                  default="false"/>
    </Condition>
    <Condition ID="CheckStatusOK"
               editable="true"/>
    <Action ID="ClawPart"
            editable="true">
      <input_port name="hand_pos"/>
      <input_port name="hand_quat"/>
      <input_port name="hand_offset"/>
      <input_port name="hand_side"/>
      <input_port name="part_type"/>
    </Action>
    <Action ID="CmdPoseWorldMoveToDestination">
      <input_port name="target_pose"/>
    </Action>
    <Condition ID="ComputeTargetPose"
               editable="true">
      <input_port name="box_pos"/>
      <input_port name="box_quat"/>
      <input_port name="target_box_offset"/>
      <output_port name="target_pose"/>
    </Condition>
    <Action ID="ControlClaw"
            editable="true">
      <input_port name="action_mode"/>
      <input_port name="hand_to_control"/>
      <input_port name="duration"/>
    </Action>
    <Action ID="GetPartPose"
            editable="true">
      <output_port name="part_pos"/>
      <output_port name="part_quat"/>
    </Action>
    <Action ID="HeadMove"
            editable="true">
      <input_port name="control_mode"/>
    </Action>
    <Action ID="SelectHandSide"
            editable="true">
      <input_port name="part_pos"/>
      <input_port name="part_quat"/>
      <input_port name="target_part_offset"/>
      <output_port name="hand_side"/>
    </Action>
    <Decorator ID="TimingDecorator"
               editable="true"/>
  </TreeNodesModel>

</root>
