# 关节保护
- [v1.0](#关节保护v10)
- [v2.0](#关节保护v20)
  - [数据截断](#一-数据截断)
    - [功能简介](#1-功能简介)
  - [峰值保护](#二-扭矩峰值保护)
  - [飞车保护](#三-速度飞车保护)
  - [堵转保护](#四-堵转保护)
  - [日志](#五-日志查看)
    - [触发日志](#1-触发日志)
    - [电机失能日志](#2-电机disable日志)
    - [电机状态日志](#3-电机状态map)
    - [数据截断日志](#4-jointcmd数据截断)
  - [测试案例](#六-测试案例)

## 关节保护v1.0
略

## 关节保护v2.0
  #### 1. 简介
  关节保护(v2.0)功能相较之间做了较大修改，在hardware_node硬件层分为两层保护：
    
    1）数据截断： 对jointCmd的位置、扭矩、速度数据做截断
    2）实时保护： 检测sensor获取每个电机的实时vel和tau数据

  ![1](images/222-0.jpg)

  实时保护即对所有电机进行峰值(扭矩)保护，堵转保护，以及飞车保护，当触发保护措施时，对相应的电机做失能操作。本文将分别对每种保护功能进行简要阐述

  * **风险**: 当前action只有电机的失能，没有停止电机的功能，所以速度较大的情况下比较危险

  #### 2. 使用说明

  当前在load_kuavo_real.launch文件中分别设置了两个参数，默认为**false**，即这两个功能都不启动

    <arg name="joint_protect_enable" default="false" />
    <arg name="cmd_truncation_enable" default="false" />

  如果要使用两个功能，请分别将其设置为**true**


### 一 数据截断

#### 1. 功能简介
 在将控制命令数据发给CSP/CSV/CST之之前，数据截断功能将对订阅jointCmd进行检测，分别检测电机的位置/速度/扭矩数据是否超过阈值。
 
 **位置阈值：**

    "min_joint_position_limits":[
        -40, -60, -140, -8, -100, -100,
        -40, -60, -140, -8, -100, -100,
        -180, -180, -180, -180, -180, -180, -180,
        -180, -180, -180, -180, -180, -180, -180, 30, 25],
    "max_joint_position_limits":[
        40, 60, 40, 170, 90, 90,
        40, 60, 40, 170, 90, 90,
        180, 180, 180, 180, 180, 180, 180,
        180, 180, 180, 180, 180, 180, 180, -30, -25],

  检测下发jointCmd中**joint_q**数据是否超出最大/最小阈值

    超过最大值，将阈值的最大值赋值给joint_q：joint_q[i] = max_joint[i]
    超过最小值，将阈值的最小值赋值给joint_q：joint_q[i] = min_joint[i]

  **速度阈值：**(获取阈值中，暂时屏蔽)

      "joint_velocity_limits":[
        4, 4, 8, 5, 4, 4,
        4, 4, 8, 5, 4, 4,
        8, 8, 8, 8, 10, 8, 8,
        8, 8, 8, 8, 10, 8, 8, 1800, 1800],

  检测下发的jointCmd中**joint_v**数据的绝对值是否超出速度阈值

    超过最大值，将阈值的最大值赋值给joint_v：joint_v[i] = velocity_limits[i]
    超过最小值，将阈值的最小值赋值给joint_v：joint_v[i] = -1*velocity_limits[i]

  **扭矩阈值：**

    "joint_peak_torque_limits":[
        200, 200, 200, 200, 200, 200,
        200, 200, 200, 200, 200, 200,
        200, 200, 200, 200, 200, 200, 200,
        200, 200, 200, 200, 200, 200, 200, 200, 200],

  检测下发的jointCmd中**tau**数据的绝对值是否超出扭矩阈值

    超过最大值，将阈值的最大值赋值给tau：tau[i] = torque_limits[i]
    超过最小值，将阈值的最小值赋值给tau：tau[i] = -1*torque_limits[i]

  * 以上功能均由程序内部自动完成，用户只需要设置相应的阈值，通过外部命令下发超过阈值的jointCmd命令查看是否触发即可


### 二 扭矩峰值保护
  * **原理**

      **场景：** 由于电机在接受的**很大**扭矩**短时间**就容易导致电机损坏。

      峰值保护是获取Sensor的实时数据，通过查看对比其中每个电机tau数值 **时间窗口**中**连续**超过设定的阈值来触发电机的保护的功能。

  

  * **阈值设定**

    * 时间窗口阈值：

    
          "peak_protection":0.1,   //单位秒

    * 峰值阈值：

          "joint_peak_torque_limits":[
          200, 200, 200, 200, 200, 200,
          200, 200, 200, 200, 200, 200,
          200, 200, 200, 200, 200, 200, 200,
          200, 200, 200, 200, 200, 200, 200, 200, 200],

### 三 速度飞车保护
  * **原理**

    **场景：** 机器人关节在某些情况下由于需要调整姿态等原因，给了电机一个很大速度，导致机器人出现踢腿，甩手臂等飞车现象。

    飞车保护是通过获取sensorData中vel实时速度的检测，检测其是否在**时间窗口**中连续超过设定阈值。

  * **阈值设定**

    * 时间窗口阈值：
    
          "speed_protection":0.1,   //单位秒，飞车保护的时间窗口阈值建议设定更短

    * 峰值阈值：

          "joint_velocity_limits":[
              4, 4, 8, 5, 4, 4,
              4, 4, 8, 5, 4, 4,
              8, 8, 8, 8, 10, 8, 8,
              8, 8, 8, 8, 10, 8, 8, 1800, 1800],

 ### 四 堵转保护
   * **原理**
    **场景：** 当电机接收一个**较大**扭矩命令，由于外部原因导致电机无法转时，这个扭矩持续作用**时间较长**会出现发热导致烧机的问题。
    堵转保护是获取Sensor的实时数据，通过查看对比其中每个电机tau数值是否在**时间窗口**中**连续**超过设定的阈值来触发电机的保护的功能。


  * **阈值设定**

    * 时间窗口阈值：
    
          "locked_rotor_protection":2,   //单位秒

    * 峰值阈值：

          "joint_torque_limits":[
              90, 90, 90, 90, 80, 80,
              90, 90, 90, 90, 80, 80,
              40, 20, 20, 20, 20, 20, 20,
              40, 20, 20, 20, 20, 20, 20, 40, 40],

    😗*ps [0]: 目前阈值只在v45中可用*
    😗*ps [1]: 1~6:左腿，7～12：有腿，13～19：左臂，20～26：右臂，27～28：头*
    😗*ps [2]: 在阈值被触发时，如果用户觉得当前操作不应该触发保护阈值，请将相应的值设置的更大，如果当前关节不想被保护，直接将当前阈值设置成1800(当阈值足大时，实时值不存在超出的可能)*

### 五 日志查看
   #### 1. 触发日志

    ################# Trigger peak protection #################
     joint[21] cur pos=-0.0804489
     value 5.05129 is over limit[5], time window 0.106036
    ###########################  ###########################

   如上所示，是触发了**峰值保护**，触发的是21号电机，触发时的电流值是5.05129，超过了设定的阈值5，触发的时间窗口是0.106036秒，表示它在这个时间区间内连续超过了阈值

   #### 2. 电机disable日志

    ####### set motor 21 disable #######
   表示将当前21号电机失能（*此时用户可以去感受当前电机是否解锁*）

   #### 3. 电机状态map

    motor status map[1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 1 1 1 0 0 1 0 1 1 1 1 1 ]
   如上所示日志，会在每次电机失能的时候都打印一次，方便用户查看当前有电机的状态（*1：使能 ，0：失能*）

   #### 4. jointCmd数据截断

    [orig] tau 19 value 24.5883 -> [max] 5
   
   表示 19 号电机输入扭矩值 24.5883 被截断成设定阈值5
   *ps[0]：数据截断日志会刷屏*


 ### 六 测试案例
 #### 1. 单项测试

  ![1](images/222-3.png)
  如图所示，单项功能测试时，请将其他两个阈值设置很大，等于屏蔽相关测试项

 #### 2. 指定关节测试

  将不需要测试的电机阈值设置成1800，即屏蔽不需要电机，只保留相关电机
  
*(后续测试案例请补充)*
